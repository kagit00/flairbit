<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="20250502-16-foreign-key-media-files" author="grok">
        <sql dbms="postgresql">
            ALTER TABLE media_files
            ADD CONSTRAINT fk_media_files_profile
            FOREIGN KEY (profile_id)
            REFERENCES profiles(id);
        </sql>
    </changeSet>

    <changeSet id="20250502-17-materialized-views" author="grok">
        <sql dbms="postgresql">
            CREATE MATERIALIZED VIEW media_like_counts AS
            SELECT ri.reel_id, COUNT(ri.id) as like_count
            FROM reel_interactions ri
            WHERE ri.interaction_type = 'LIKE'
            GROUP BY ri.reel_id;
            CREATE INDEX idx_media_like_counts_reel_id ON media_like_counts(reel_id);

            CREATE MATERIALIZED VIEW media_view_counts AS
            SELECT ri.reel_id, COUNT(ri.id) as view_count
            FROM reel_interactions ri
            WHERE ri.interaction_type = 'VIEW'
            GROUP BY ri.reel_id;
            CREATE INDEX idx_media_view_counts_reel_id ON media_view_counts(reel_id);
        </sql>
    </changeSet>

    <changeSet id="add-indexes-match-suggestions" author="gsss">
        <createIndex
                tableName="match_suggestions"
                indexName="idx_match_suggestions">
            <column name="participant_id"/>
            <column name="group_id"/>
            <column name="id"/>
            <column name="compatibility_score"/>
        </createIndex>
    </changeSet>

    <changeSet id="add-gin-index-preferences" author="gsss">
        <sql>
            <![CDATA[
            CREATE INDEX idx_preferences_preferred_genders ON preferences USING GIN (string_to_array(trim(both '{}' from preferred_genders), ','));
        ]]>
        </sql>
    </changeSet>

    <changeSet id="20250514-001-users-query-indexes" author="grok">
        <createIndex indexName="idx_user_match_states_group_sent_ready_profile" tableName="user_match_states">
            <column name="group_id"/>
            <column name="sent_to_matching_service"/>
            <column name="ready_for_matching"/>
            <column name="profile_id"/>
        </createIndex>
        <rollback>
            <dropIndex indexName="idx_user_match_states_group_sent_ready_profile" tableName="user_match_states"/>
        </rollback>
    </changeSet>

</databaseChangeLog>